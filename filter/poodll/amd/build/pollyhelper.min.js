define(["jquery","core/log"],(function($,log){return log.debug("Polly Helper: initialising"),{sentenceURLs:[],sentencetexts:[],wordstarts:[],wordcounts:[],textblock:!1,textstring:!1,wordselector:"",sentenceselector:"",passagecssclass:"filterpoodll_pollytextblock_cont",cloudpoodlltoken:"",voice:"",highlightmode:"",theplayer:!1,pendingurls:0,clone:function(){return $.extend(!0,{},this)},reset:function(){this.unspanify_text_passage(),this.textblock=!1,this.textstring=!1,this.sentenceURLs=[],this.sentencetexts=[],this.wordstarts=[],this.wordcounts=[]},set_textblock:function(textblock){var that=this;if(textblock!==this.textblock){!1!==this.textblock&&this.reset(),this.textblock=textblock;textblock.text();this.spanify_text_passage(),this.sentencetexts=this.get_sentences_from_spanified_text(),this.pendingurls=this.sentencetexts.length;for(var previousend=0,currentsentence=0;currentsentence<this.sentencetexts.length;currentsentence++){this.wordstarts[currentsentence]=previousend,this.wordcounts[currentsentence]=this.split_into_words(this.sentencetexts[currentsentence]).length,previousend+=this.wordcounts[currentsentence];var speaktext=this.sentencetexts[currentsentence];this.fetch_polly_url(speaktext,function(sentenceindex){return function(pollyurl){that.sentenceURLs[sentenceindex]=pollyurl,log.debug(sentenceindex+" "+pollyurl),that.pendingurls--}}(currentsentence))}}else log.debug("it was the same textblock")},set_text:function(textstring){var that=this;textstring!==this.textstring?(!1!==this.textblock&&this.reset(),this.textstring=textstring,this.sentencetexts[0]=textstring,this.pendingurls=1,this.fetch_polly_url(textstring,(function(pollyurl){that.sentenceURLs[0]=pollyurl,log.debug("0 "+pollyurl),that.pendingurls--}))):log.debug("it was the same textstring")},init:function(theplayer,itemid,textblock,voice,sentenceselector,wordselector,passagecssclass,highlightmode,cloudpoodlltoken){this.sentenceselector=sentenceselector,this.wordselector=wordselector,this.passagecssclass=passagecssclass,this.cloudpoodlltoken=cloudpoodlltoken,this.highlightmode=highlightmode,this.voice=voice,this.theplayer=theplayer,this.set_textblock(textblock)},split_into_sentences:function(thetext){return""===(thetext=thetext.replace(/\s+/g," ").trim())?[]:thetext.match(/([^\.!\?]+[\.!\?"']+)|([^\.!\?"']+$)/g)},split_into_words:function(thetext){return""===(thetext=thetext.replace(/\s+/g," ").trim())?[]:thetext.split(" ")},fetch_polly_url:function(speaktext,callback){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(e){if(4===this.readyState)if(200===xhr.status){var payload=xhr.responseText,payloadobject=JSON.parse(payload);if(payloadobject){if(payloadobject.returnCode>0)return console.log(payloadobject.returnMessage),!1;if(0===payloadobject.returnCode){var pollyurl=payloadobject.returnMessage;callback(pollyurl)}else console.log("Polly Signed URL Request failed:"),console.log(payloadobject)}else console.log("Polly Signed URL Request something bad happened")}else console.log("Polly Signed URL Request Not 200 response:"+xhr.status)};var xhrparams="wstoken="+this.cloudpoodlltoken+"&wsfunction=local_cpapi_fetch_polly_url&moodlewsrestformat=json&text="+encodeURIComponent(speaktext)+"&texttype=text&voice="+this.voice+"&appid=filter_poodll&owner=poodll&region=useast1";xhr.open("POST","https://cloud.poodll.com/webservice/rest/server.php",!0),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(xhrparams)},isHTML:function(testString){return new RegExp("<([A-Za-z][A-Za-z0-9]*)\\b[^>]*>(.*?)</\\1>").test(testString)},unspanify_text_passage:function(){this.textblock.removeClass(this.passagecssclass),"word"===this.highlightmode?this.textblock.find(".tbr_word").contents().unwrap():this.textblock.find(".tbr_sentence").contents().unwrap()},spanify_text_passage:function(){var that=this,itemcount=-1;this.textblock.addClass(this.passagecssclass),this.textblock.find("*").contents().filter((function(){return 3===this.nodeType})).each((function(){var retpieces="";if("word"===that.highlightmode)for(var thewords=that.split_into_words($(this).text()),theword=0;theword<thewords.length;theword++)retpieces=retpieces+'<span class="tbr_word" data-wordindex="'+ ++itemcount+'">'+thewords[theword]+"</span> ";else for(var thesentences=that.split_into_sentences($(this).text()),thesentence=0;thesentence<thesentences.length;thesentence++)retpieces=retpieces+'<span class="tbr_sentence" data-sentenceindex="'+ ++itemcount+'">'+thesentences[thesentence]+"</span>&nbsp;";$(this).replaceWith(retpieces)}))},get_sentences_from_spanified_text:function(){var sentences=[];return this.textblock.find("span.tbr_sentence").each((function(){sentences.push($(this).text())})),sentences},dehighlight_all:function(){switch(this.highlightmode){case"word":$(this.wordselector,this.textblock).removeClass("activesentence");break;case"sentence":$(this.sentenceselector).removeClass("activesentence")}},highlight_sentence:function(thesentence_index){switch(this.highlightmode){case"word":$(this.wordselector,this.textblock).removeClass("activesentence"),$(this.wordselector,this.textblock).slice(this.wordstarts[thesentence_index],this.wordstarts[thesentence_index]+this.wordcounts[thesentence_index]).addClass("activesentence");break;case"sentence":$(this.sentenceselector).removeClass("activesentence"),$(this.sentenceselector+"[data-sentenceindex="+thesentence_index+"]").addClass("activesentence")}},doplayaudio:function(thesentence){var that=this;this.pendingurls>0?setTimeout((function(){that.doplayaudio(thesentence)}),100):("number"==typeof thesentence?(this.dehighlight_all(),this.highlight_sentence(thesentence),this.theplayer.attr("src",this.sentenceURLs[thesentence])):this.sentenceURLs.length>0&&this.theplayer.attr("src",this.sentenceURLs[0]),this.theplayer[0].load(),this.theplayer[0].play())}}}));

//# sourceMappingURL=pollyhelper.min.js.map
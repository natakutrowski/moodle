define(["jquery","core/log","mod_readaloud/definitions","core/str","core/ajax","core/templates","core/notification"],(function($,log,def,str,Ajax,templates,notification){return log.debug("Click to hear: initialising"),{controls:{},ready:!1,remotetranscribe:!1,showstats:!0,showgrades:!0,notingradebook:!1,attemptid:0,checking:"... checking ...",secstillcheck:"Checking again in: ",notgradedyet:"Your reading has not been evaluated yet.",evaluated:"Your reading has been evaluated.",notaddedtogradebook:"This was a shadow practice, and not added to gradebook.",init:function(opts){this.attemptid=opts.attemptid,this.ready=opts.ready,this.remotetranscribe=opts.remotetranscribe,this.showstats=opts.showstats,this.showgrades=opts.showgrades,this.filename=opts.filename,this.notingradebook=opts.notingradebook,this.init_strings(),this.register_controls(),this.register_events(),!this.ready&&this.attemptid&&(this.remotetranscribe&&this.check_for_results(this,15),this.check_for_audio(0))},init_strings:function(){var that=this;str.get_string("checking","mod_readaloud").done((function(s){that.checking=s})),str.get_string("secs_till_check","mod_readaloud").done((function(s){that.secstillcheck=s})),str.get_string("notgradedyet","mod_readaloud").done((function(s){that.notgradedyet=s})),str.get_string("evaluatedmessage","mod_readaloud").done((function(s){that.evaluated=s})),str.get_string("notaddedtogradebook","mod_readaloud").done((function(s){that.notaddedtogradebook=s}))},register_controls:function(){this.controls.heading=$("."+def.smallreportheading),this.controls.player=$("."+def.smallreportplayer),this.controls.dummyplayer=$("."+def.smallreportdummyplayer),this.controls.stars=$("."+def.smallreportstars),this.controls.cards=$("."+def.smallreportcards),this.controls.status=$("."+def.smallreportstatus),this.controls.fullreportbutton=$("."+def.fullreportbutton)},register_events:function(){},check_for_audio:function(waitms){var that=this;$.ajax({url:that.filename,method:"HEAD",cache:!1,error:function(){log.debug("403 errors are normal here, till the audio file arrives back from conversion"),setTimeout((function(){that.check_for_audio(waitms+500)}),waitms)},success:function(data,textStatus,xhr){if(200===xhr.status){var tdata=[];tdata.src=that.filename,tdata.UNIQID=that.generate_random_string(8),templates.render("mod_readaloud/audioplayer",tdata).then((function(html,js){templates.appendNodeContents("."+def.smallreportplayer,html,js),that.controls.dummyplayer.hide()}))}else setTimeout((function(){that.check_for_audio(waitms+500)}),waitms)}})},generate_random_string:function(length){for(var result="",characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",charactersLength=characters.length,i=0;i<length;i++)result+=characters.charAt(Math.floor(Math.random()*charactersLength));return result},check_for_results:function(that,seconds){if((seconds-=1)>0)return setTimeout(that.check_for_results,1e3,that,seconds),void that.controls.status.text(that.secstillcheck+seconds);that.controls.status.text(that.checking),Ajax.call([{methodname:"mod_readaloud_check_for_results",args:{attemptid:that.attemptid},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)switch(payloadobject.ready){case!0:log.debug("result fetched");var heading=that.evaluated;that.notingradebook&&(heading=heading+" "+that.notaddedtogradebook),that.controls.heading.text(heading);var tdata=[];tdata.ready=payloadobject.ready,that.showgrades||(payloadobject.rating=5);for(var stars=[],star=0;star<5;star++)stars[star]=payloadobject.rating>star?"fa-star":"fa-star-o";if(tdata.stars=stars,templates.render("mod_readaloud/smallreportstars",tdata).then((function(html,js){that.controls.stars.html(html)})),!that.showstats){that.controls.status.hide(),that.controls.fullreportbutton.show();break}tdata.wpm=payloadobject.wpm,tdata.acc=payloadobject.acc,tdata.totalwords=payloadobject.totalwords,templates.render("mod_readaloud/smallreportcards",tdata).then((function(html,js){that.controls.cards.html(html)})),that.controls.status.hide(),that.controls.fullreportbutton.show();break;default:log.debug("result not fetched"),setTimeout(that.check_for_results,1e3,that,10),that.controls.status.text(that.secstillcheck+seconds)}},fail:notification.exception}])}}}));

//# sourceMappingURL=smallreporthelper.min.js.map
define(["jquery","core/log","core/ajax"],(function($,log,ajax){return log.debug("ReadAloud Text Utils: initialising"),{token:"",region:"",owner:"",setCloudPoodllToken:function(token){this.token=token},countWords:function(sentence){return((sentence=sentence.trim()).match(/ /g)||[]).length+1},stripTags:function(input){return void 0===input||null==input?"":input.replace(/<[^>]*>/g,"")},getSelectedWord:function(){var selectedText="";if(window.getSelection?selectedText=window.getSelection().toString():document.selection&&"Control"!==document.selection.type&&(selectedText=document.selection.createRange().text),selectedText.length>0){var words=selectedText.split(/\s+/);if(words.length>0)return words[0]}return selectedText},analyzeText:function(text){const words=(text=this.stripTags(text)).split(/\s+/),wordCount=words.length,totalChars=text.length,averageWordLength=(words.reduce(((acc,word)=>acc+word.length),0)/wordCount).toFixed(1),sentences=text.split(/[.!?]+/);var sentenceCount=sentences.length-1;sentenceCount<1&&wordCount>0&&(sentenceCount=1);for(var totalSentenceLength=0,i=0;i<sentences.length;i++)totalSentenceLength+=this.countWords(sentences[i]);var averageSentenceLength=0;return sentenceCount>0&&(averageSentenceLength=(totalSentenceLength/sentenceCount).toFixed(1)),{charCount:totalChars,wordCount:wordCount,avWordLength:averageWordLength,sentenceCount:sentenceCount,avSentenceLength:averageSentenceLength}},cleanWord:function(inputWord){return inputWord.toLowerCase().replace(/^[^\w]+|[^\w]+$/g,"")},downloadTextContent:function(textcontent,fileName){var blob=new Blob([textcontent],{type:"text/plain"}),link=document.createElement("a");link.href=window.URL.createObjectURL(blob),link.download=fileName,document.body.appendChild(link),link.click(),document.body.removeChild(link)},call_ai:function(prompt,language,subject,action,callback){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(e){if(4===this.readyState)if(200==xhr.status){var payload=xhr.responseText,payloadobject=JSON.parse(payload);if(payloadobject){if(payloadobject.returnCode>0)return console.log(payloadobject.returnMessage),!1;if(0===payloadobject.returnCode){var pollyurl=payloadobject.returnMessage;callback(pollyurl)}else console.log(" Request failed:"),console.log(payloadobject)}else console.log(" Request something bad happened")}else console.log("Request Not 200 response:"+xhr.status)};var xhrparams="wstoken="+this.token+"&wsfunction=local_cpapi_call_ai&moodlewsrestformat=json&prompt="+encodeURIComponent(prompt)+"&language="+language+"&subject="+subject+"&action="+action+"&appid=mod_readaloud&owner=poodll&region=useast1";xhr.open("POST","https://cloud.poodll.com/webservice/rest/server.php",!0),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(xhrparams)},init:function(token,region,owner){this.token=token,this.region=region,this.owner=owner},clean_ssml_chars:function(speaktext){return speaktext=(speaktext=(speaktext=(speaktext=(speaktext=speaktext.replace(/&/g,"&amp;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")},can_speak_neural:function(voice,region){switch(region){case"useast1":case"tokyo":case"sydney":case"dublin":case"ottawa":case"frankfurt":case"london":case"singapore":case"capetown":break;default:return!1}return-1!==def.neural_voices.indexOf(voice)},fetch_polly_url:function(speaktext,voiceoption,voice){var that=this;return new Promise((function(resolve,reject){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(e){if(4===this.readyState)if(200==xhr.status){var payload=xhr.responseText,payloadobject=JSON.parse(payload);if(payloadobject){if(payloadobject.returnCode>0)return reject(payloadobject.returnMessage),log.debug(payloadobject.returnMessage),!1;if(0===payloadobject.returnCode){var pollyurl=payloadobject.returnMessage;resolve(pollyurl)}else reject("Polly Signed URL Request failed:"),log.debug("Polly Signed URL Request failed:"),log.debug(payloadobject)}else reject("Polly Signed URL Request something bad happened"),log.debug("Polly Signed URL Request something bad happened")}else reject("Polly Signed URL Request Not 200 response:"+xhr.status),log.debug("Polly Signed URL Request Not 200 response:"+xhr.status)};switch(parseInt(voiceoption)){case 1:speaktext='<speak><break time="1000ms"></break><prosody rate="slow">'+(speaktext=that.clean_ssml_chars(speaktext))+"</prosody></speak>";break;case 2:speaktext='<speak><break time="1000ms"></break><prosody rate="x-slow">'+(speaktext=that.clean_ssml_chars(speaktext))+"</prosody></speak>";break;case 3:speaktext="<speak>"+speaktext+"</speak>";break;default:speaktext='<speak><break time="1000ms"></break>'+(speaktext=that.clean_ssml_chars(speaktext))+"</speak>"}var engine=that.can_speak_neural(voice,that.region)?"neural":"standard",xhrparams="wstoken="+that.token+"&wsfunction=local_cpapi_fetch_polly_url&moodlewsrestformat=json&text="+encodeURIComponent(speaktext)+"&texttype=ssml&voice="+voice+"&appid="+def.component+"&owner="+that.owner+"&region="+that.region+"&engine="+engine,serverurl=def.cloudpoodllurl+"/webservice/rest/server.php";xhr.open("POST",serverurl,!0),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(xhrparams)}))}}}));

//# sourceMappingURL=textutils.min.js.map
{"version":3,"file":"wordpreview.min.js","sources":["../src/wordpreview.js"],"sourcesContent":["/**\r\n * Word Preview Module\r\n *\r\n * @package mod_wordcards\r\n * @author  Justin Hunt - poodll.com\r\n * *\r\n */\r\n\r\ndefine([\r\n  'jquery',\r\n  'core/ajax',\r\n  'core/log',\r\n  'core/str',\r\n  'mod_wordcards/a4e',\r\n  'mod_wordcards/textfit',\r\n  'core/templates',\r\n  'core/notification'\r\n], function($, Ajax, log, str, a4e, textFit, templates, notification) {\r\n\r\n  var app = {\r\n    dryRun: false,\r\n    termAtTop: \"0\",\r\n    strings: {},\r\n    nexturl: '',\r\n\r\n    init: function(props) {\r\n\r\n      //pick up opts from html\r\n      var theid = '#' + props.widgetid;\r\n      this.dryRun = props.dryRun;\r\n      this.nexturl = props.nexturl;\r\n      this.modid = props.modid;\r\n      this.msoptions=props.msoptions;\r\n      this.isFreeMode = props.isfreemode;\r\n      var configcontrol = $(theid).get(0);\r\n      if (configcontrol) {\r\n        var appdata = JSON.parse(configcontrol.value);\r\n        $(theid).remove();\r\n      } else {\r\n        //if there is no config we might as well give up\r\n        log.debug('No config found on page. Giving up.');\r\n        return;\r\n      }\r\n\r\n      //init strings\r\n      this.init_strings();\r\n\r\n      //set next url\r\n      if(app.nexturl === '') {\r\n        var currentUrl = new URL(window.location.href);\r\n        currentUrl.searchParams.delete('practicetype');\r\n        app.nexturl = currentUrl.toString();\r\n      }\r\n      log.debug(\"Next URL: \" + app.nexturl);\r\n\r\n      app.process(appdata);\r\n\r\n      a4e.register_events();\r\n      a4e.init_audio(props.token,props.region,props.owner);\r\n\r\n      this.register_events();\r\n    },\r\n\r\n    init_strings: function(){\r\n        // set up strings\r\n        str.get_strings([\r\n            {\"key\": \"nowordsselected\", \"component\": 'mod_wordcards'},\r\n            {\"key\": \"selectedwordstest\", \"component\": 'mod_wordcards'},\r\n            {\"key\": \"continue\", \"component\": 'core'},\r\n        ]).done(function(s) {\r\n            var i = 0;\r\n            app.strings.nowordsselected = s[i++];\r\n            app.strings.selectedwordstest = s[i++];\r\n            app.strings.continue = s[i++];\r\n        });\r\n    },\r\n\r\n    register_events: function() {\r\n\r\n      $('body').on('click', \"#wordcards-close-results\", function(e) {\r\n        e.preventDefault();\r\n        var total_time = app.timer.count;\r\n        log.debug(\"app.nexturl\" + app.nexturl);\r\n        var url = app.nexturl.replace(/&amp;/g, '&') + \"&localscattertime=\" + total_time\r\n        window.location.replace(url);\r\n      });\r\n\r\n      $('body').on('click', \"#wordcards-try-again\", function() {\r\n        location.reload();\r\n      });\r\n\r\n      $(\"body\").on('click', '.a4e-distractor', function(e) {\r\n        app.check($(this).data('correct'), this);\r\n      });\r\n\r\n      $('body').on('click', '#wordcards-start-button', function(e) {\r\n        e.preventDefault();\r\n        //collect terms that were selected\r\n        var selectedcheckboxes = $(\"#selfselect-inner .wc_selfselector\").find('input:checked');\r\n        app.selectedterms= [];\r\n        for (var i = 0; i < selectedcheckboxes.length; i++) {\r\n          var termid = $(selectedcheckboxes[i]).data('termid');\r\n          // If its already learned, we do not need to test it.\r\n          // We only test the self selected ones (and  not ye learned ones)\r\n          var learned = $(selectedcheckboxes[i]).data('learned');\r\n          if(learned==1 || learned=='true'){\r\n            continue;\r\n          }\r\n          // Push the term into the selected terms array\r\n          var term = app.terms.filter(function(t) {\r\n            return t.id == termid;\r\n          })[0];\r\n          app.selectedterms.push(term);\r\n        }\r\n        log.debug(\"Next URL confirm: \" + app.nexturl);\r\n        //if some words are selected start test. If not confirm and redirect\r\n        if(app.selectedterms.length === 0){\r\n          notification.confirm(app.strings.continue, \r\n            app.strings.nowordsselected,\r\n            app.strings.continue,'',\r\n            function(){\r\n              var theurl = app.nexturl.replace(/&amp;/g, '&')\r\n              window.location.href=theurl;\r\n            });\r\n          return;\r\n        }else{\r\n          notification.confirm(app.strings.continue, \r\n            app.strings.selectedwordstest,\r\n            app.strings.continue,'',\r\n            app.start);\r\n          return;\r\n        }\r\n        \r\n      });\r\n\r\n    },\r\n\r\n    process: function(appdata) {\r\n\r\n      app.terms = appdata.terms;\r\n      a4e.list_selfselect(\"#selfselect-inner\", appdata.terms);\r\n\r\n    },\r\n    start: function() {\r\n      app.results = [];\r\n      a4e.shuffle(app.selectedterms);\r\n      app.pointer = 0;\r\n      $(\".selfselect-container, #wordcards-start-button\").hide();\r\n      $(\"#wordcards-gameboard\").show();\r\n      $(\"#wordcards-time-counter\").text(\"00:00\");\r\n      app.timer = {\r\n        interval: setInterval(function() {\r\n          app.timer.update();\r\n        }, 1000),\r\n        count: 0,\r\n        update: function() {\r\n          app.timer.count++;\r\n          $(\"#wordcards-time-counter\").text(a4e.pretty_print_secs(app.timer.count));\r\n        }\r\n      }\r\n      app.next();\r\n    },\r\n    quit: function() {\r\n      clearInterval(app.timer.interval);\r\n      $(\"#wordcards-gameboard\").hide();\r\n      $(\"#wordcards-vocab-list, #wordcards-start-button\").show();\r\n    },\r\n\r\n    end: function() {\r\n      clearInterval(app.timer.interval);\r\n      $(\"#wordcards-gameboard, #wordcards-start-button\").hide();\r\n      $(\"#wordcards-results\").show();\r\n\r\n      //template data\r\n      var tdata = [];\r\n      tdata['nexturl'] = this.nexturl;\r\n      tdata['results'] = app.results;\r\n      tdata['total'] = app.selectedterms.length;\r\n      tdata['totalcorrect'] = a4e.calc_total_points(app.results);\r\n      var total_time = app.timer.count;\r\n      if (total_time == 0) {\r\n        tdata['prettytime'] = '00:00';\r\n      } else {\r\n        tdata['prettytime'] = a4e.pretty_print_secs(total_time);\r\n      }\r\n      templates.render('mod_wordcards/wordpreview_feedback', tdata).then(\r\n        function(html, js) {\r\n          $(\"#results-inner\").html(html);\r\n          // Add listeners for the \"Add to my words\" buttons.\r\n          require([\"mod_wordcards/mywords\"], function(mywords) {\r\n            mywords.initFromFeedbackPage();\r\n          });\r\n        }\r\n      );\r\n    },\r\n\r\n    next: function() {\r\n      a4e.progress_dots(app.results, app.selectedterms);\r\n      var templateopts=app.selectedterms[app.pointer];\r\n      if(app.msoptions===app.termAtTop){\r\n        templateopts.termisheader=true;\r\n      }\r\n      templates.render('mod_wordcards/definition_as_header', templateopts).then(\r\n          function(html, js) {\r\n            $(\"#wordcards-question\").html(html);\r\n            //do text fit\r\n            var defheaders = $(\".definition-as-header\");\r\n            textFit(defheaders, {\r\n              multiLine: true,\r\n              maxFontSize: 50,\r\n              alignHoriz: true,\r\n              alignVert: true\r\n            });\r\n          }\r\n      );\r\n\r\n      $(\"#wordcards-input\").html(app.get_distractors());\r\n\r\n    },\r\n\r\n    check: function(correct, clicked) {\r\n      var points = 0;\r\n      if (correct == true) {\r\n        //createjs.Sound.play('correct');\r\n        points = 1;\r\n      } else {\r\n        //createjs.Sound.play('incorrect');\r\n      }\r\n      $(\".a4e-distractor\").css('pointer-events', 'none');\r\n      \r\n      var result = {\r\n        question: app.selectedterms[app.pointer]['definition'],\r\n        selected: $(clicked).text(),\r\n        correct: app.selectedterms[app.pointer]['term'],\r\n        points: points,\r\n        id: app.selectedterms[app.pointer]['id']\r\n      };\r\n      \r\n      app.results.push(result);\r\n\r\n      var background = correct == true ? 'a4e-correct' : 'a4e-incorrect';\r\n      $(clicked).addClass(background).append(\"<i style='color:\" + (correct ? 'green' : 'red') + \";margin-left:5px;' class='fa fa-\" + (correct ? 'check' : 'times') + \"'></i>\").parent().addClass('a4e-click-disabled');\r\n\r\n      if (!correct) {\r\n        $(\".a4e-distractor[data-correct='true']\").addClass('a4e-correct').append(\"<i style='color:green;margin-left:5px;' class='fa fa-check'></i>\");\r\n      }\r\n\r\n      //post results to server\r\n      if (correct) {\r\n        this.reportSuccess(app.selectedterms[app.pointer]['id']);\r\n      }\r\n\r\n      app.pointer++;\r\n      if (!correct) {\r\n        setTimeout(function() {\r\n          if (app.pointer < app.selectedterms.length) {\r\n            app.next();\r\n          } else {\r\n            app.end();\r\n          }\r\n        }, 1500)\r\n      } else {\r\n        setTimeout(function() {\r\n          if (app.pointer < app.selectedterms.length) {\r\n            app.next();\r\n          } else {\r\n            app.end();\r\n          }\r\n        }, 1000)\r\n      }\r\n    },\r\n\r\n    get_distractors: function() {\r\n      var distractors = app.terms.slice(0);\r\n      //find pointer in terms of current term in selected terms\r\n      var termspointer = app.terms.findIndex(function(t) {\r\n        return t.id === app.selectedterms[app.pointer].id;\r\n      });\r\n      var answer = app.terms[termspointer]['term'];\r\n      distractors.splice(termspointer, 1);\r\n      a4e.shuffle(distractors);\r\n      distractors = distractors.slice(0, 4);\r\n      distractors.push(app.terms[termspointer]);\r\n      a4e.shuffle(distractors);\r\n      var options = [];\r\n      $.each(distractors, function(i, o) {\r\n        var is_correct = o['term'] == answer;\r\n        var term_id = o['id'];\r\n        //depending on options  show option label as term or def\r\n        if(app.msoptions===app.termAtTop){\r\n          var label= o['definition'];\r\n        }else{\r\n          var label= o['term'];\r\n        }\r\n        options.push('<li data-id=\"' + term_id + '\" data-correct=\"' + is_correct.toString() + '\" class=\"list-group-item a4e-distractor a4e-noselect\">' + label + '</li>');\r\n      });\r\n      var code = '<ul class=\"list-group a4e-distractors\">' + options.join('') + '</ul>';\r\n      return code;\r\n    },\r\n\r\n    reportSuccess: function(termid) {\r\n      if (this.dryRun) {\r\n        return;\r\n      }\r\n\r\n      Ajax.call([{\r\n        methodname: 'mod_wordcards_report_successful_learnclaim',\r\n        args: {\r\n          termid: termid\r\n        }\r\n      }]);\r\n    }\r\n  };\r\n\r\n  return app;\r\n\r\n});"],"names":["define","$","Ajax","log","str","a4e","textFit","templates","notification","app","dryRun","termAtTop","strings","nexturl","init","props","theid","widgetid","modid","msoptions","isFreeMode","isfreemode","configcontrol","get","appdata","JSON","parse","value","remove","init_strings","currentUrl","URL","window","location","href","searchParams","delete","toString","debug","process","register_events","init_audio","token","region","owner","get_strings","done","s","i","nowordsselected","selectedwordstest","continue","on","e","preventDefault","total_time","timer","count","url","replace","reload","check","this","data","selectedcheckboxes","find","selectedterms","length","termid","learned","term","terms","filter","t","id","push","confirm","theurl","start","list_selfselect","results","shuffle","pointer","hide","show","text","interval","setInterval","update","pretty_print_secs","next","quit","clearInterval","end","tdata","calc_total_points","render","then","html","js","require","mywords","initFromFeedbackPage","progress_dots","templateopts","termisheader","defheaders","multiLine","maxFontSize","alignHoriz","alignVert","get_distractors","correct","clicked","points","css","result","question","selected","background","addClass","append","parent","reportSuccess","setTimeout","distractors","slice","termspointer","findIndex","answer","splice","options","each","o","is_correct","term_id","label","join","call","methodname","args"],"mappings":"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"}
define(["jquery","core/ajax","core/log","core/str","mod_wordcards/a4e","mod_wordcards/textfit","core/templates","core/notification"],(function($,Ajax,log,str,a4e,textFit,templates,notification){var app={dryRun:!1,termAtTop:"0",strings:{},nexturl:"",init:function(props){var theid="#"+props.widgetid;this.dryRun=props.dryRun,this.nexturl=props.nexturl,this.modid=props.modid,this.msoptions=props.msoptions,this.isFreeMode=props.isfreemode;var configcontrol=$(theid).get(0);if(configcontrol){var appdata=JSON.parse(configcontrol.value);if($(theid).remove(),this.init_strings(),""===app.nexturl){var currentUrl=new URL(window.location.href);currentUrl.searchParams.delete("practicetype"),app.nexturl=currentUrl.toString()}log.debug("Next URL: "+app.nexturl),app.process(appdata),a4e.register_events(),a4e.init_audio(props.token,props.region,props.owner),this.register_events()}else log.debug("No config found on page. Giving up.")},init_strings:function(){str.get_strings([{key:"nowordsselected",component:"mod_wordcards"},{key:"selectedwordstest",component:"mod_wordcards"},{key:"continue",component:"core"}]).done((function(s){var i=0;app.strings.nowordsselected=s[i++],app.strings.selectedwordstest=s[i++],app.strings.continue=s[i++]}))},register_events:function(){$("body").on("click","#wordcards-close-results",(function(e){e.preventDefault();var total_time=app.timer.count;log.debug("app.nexturl"+app.nexturl);var url=app.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+total_time;window.location.replace(url)})),$("body").on("click","#wordcards-try-again",(function(){location.reload()})),$("body").on("click",".a4e-distractor",(function(e){app.check($(this).data("correct"),this)})),$("body").on("click","#wordcards-start-button",(function(e){e.preventDefault();var selectedcheckboxes=$("#selfselect-inner .wc_selfselector").find("input:checked");app.selectedterms=[];for(var i=0;i<selectedcheckboxes.length;i++){var termid=$(selectedcheckboxes[i]).data("termid"),learned=$(selectedcheckboxes[i]).data("learned");if(1!=learned&&"true"!=learned){var term=app.terms.filter((function(t){return t.id==termid}))[0];app.selectedterms.push(term)}}return log.debug("Next URL confirm: "+app.nexturl),0===app.selectedterms.length?void notification.confirm(app.strings.continue,app.strings.nowordsselected,app.strings.continue,"",(function(){var theurl=app.nexturl.replace(/&amp;/g,"&");window.location.href=theurl})):void notification.confirm(app.strings.continue,app.strings.selectedwordstest,app.strings.continue,"",app.start)}))},process:function(appdata){app.terms=appdata.terms,a4e.list_selfselect("#selfselect-inner",appdata.terms)},start:function(){app.results=[],a4e.shuffle(app.selectedterms),app.pointer=0,$(".selfselect-container, #wordcards-start-button").hide(),$("#wordcards-gameboard").show(),$("#wordcards-time-counter").text("00:00"),app.timer={interval:setInterval((function(){app.timer.update()}),1e3),count:0,update:function(){app.timer.count++,$("#wordcards-time-counter").text(a4e.pretty_print_secs(app.timer.count))}},app.next()},quit:function(){clearInterval(app.timer.interval),$("#wordcards-gameboard").hide(),$("#wordcards-vocab-list, #wordcards-start-button").show()},end:function(){clearInterval(app.timer.interval),$("#wordcards-gameboard, #wordcards-start-button").hide(),$("#wordcards-results").show();var tdata=[];tdata.nexturl=this.nexturl,tdata.results=app.results,tdata.total=app.selectedterms.length,tdata.totalcorrect=a4e.calc_total_points(app.results);var total_time=app.timer.count;tdata.prettytime=0==total_time?"00:00":a4e.pretty_print_secs(total_time),templates.render("mod_wordcards/wordpreview_feedback",tdata).then((function(html,js){$("#results-inner").html(html),require(["mod_wordcards/mywords"],(function(mywords){mywords.initFromFeedbackPage()}))}))},next:function(){a4e.progress_dots(app.results,app.selectedterms);var templateopts=app.selectedterms[app.pointer];app.msoptions===app.termAtTop&&(templateopts.termisheader=!0),templates.render("mod_wordcards/definition_as_header",templateopts).then((function(html,js){$("#wordcards-question").html(html);var defheaders=$(".definition-as-header");textFit(defheaders,{multiLine:!0,maxFontSize:50,alignHoriz:!0,alignVert:!0})})),$("#wordcards-input").html(app.get_distractors())},check:function(correct,clicked){var points=0;1==correct&&(points=1),$(".a4e-distractor").css("pointer-events","none");var result={question:app.selectedterms[app.pointer].definition,selected:$(clicked).text(),correct:app.selectedterms[app.pointer].term,points:points,id:app.selectedterms[app.pointer].id};app.results.push(result);var background=1==correct?"a4e-correct":"a4e-incorrect";$(clicked).addClass(background).append("<i style='color:"+(correct?"green":"red")+";margin-left:5px;' class='fa fa-"+(correct?"check":"times")+"'></i>").parent().addClass("a4e-click-disabled"),correct||$(".a4e-distractor[data-correct='true']").addClass("a4e-correct").append("<i style='color:green;margin-left:5px;' class='fa fa-check'></i>"),correct&&this.reportSuccess(app.selectedterms[app.pointer].id),app.pointer++,correct?setTimeout((function(){app.pointer<app.selectedterms.length?app.next():app.end()}),1e3):setTimeout((function(){app.pointer<app.selectedterms.length?app.next():app.end()}),1500)},get_distractors:function(){var distractors=app.terms.slice(0),termspointer=app.terms.findIndex((function(t){return t.id===app.selectedterms[app.pointer].id})),answer=app.terms[termspointer].term;distractors.splice(termspointer,1),a4e.shuffle(distractors),(distractors=distractors.slice(0,4)).push(app.terms[termspointer]),a4e.shuffle(distractors);var options=[];return $.each(distractors,(function(i,o){var is_correct=o.term==answer,term_id=o.id;if(app.msoptions===app.termAtTop)var label=o.definition;else label=o.term;options.push('<li data-id="'+term_id+'" data-correct="'+is_correct.toString()+'" class="list-group-item a4e-distractor a4e-noselect">'+label+"</li>")})),'<ul class="list-group a4e-distractors">'+options.join("")+"</ul>"},reportSuccess:function(termid){this.dryRun||Ajax.call([{methodname:"mod_wordcards_report_successful_learnclaim",args:{termid:termid}}])}};return app}));

//# sourceMappingURL=wordpreview.min.js.map
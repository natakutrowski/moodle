define(["jquery","core/log","qtype_cloudpoodll/cloudpoodllloader","core/templates"],(function($,log,cloudpoodll,templates){return log.debug("cloudpoodll helper: initialising"),{configs:{},init:function(opts){var config={};config.component=opts.component,config.data_id=opts.data_id,config.inputname=opts.inputname,config.transcriber=opts.transcriber,config.uploadstate=!1,config.safesave=opts.safesave;var name=CSS.escape(config.inputname);config.controls={nextpagebtn:$(".submitbtns .mod_quiz-next-nav"),mediaurl:$("input[name="+name+"mediaurl]"),transcript:$("input[name="+name+"transcript]"),details:$("input[name="+name+"details]"),answer:$("input[name="+name+"]"),answerstatus:$("div#"+name+"_asc")},this.configs[config.data_id]=config;var that=this,gspeech="";cloudpoodll.init(config.data_id,(function(evt){var theconfig=that.configs[evt.id];if(theconfig)switch(that.logDetails(theconfig.controls.details,theconfig.controls.answerstatus,evt),evt.type){case"recording":if("started"===evt.action){gspeech="";var cpquestionStarted=new CustomEvent("cpquestionStarted",{details:evt});document.dispatchEvent(cpquestionStarted),1==theconfig.safesave&&(theconfig.controls.nextpagebtn.attr("disabled","disabled"),$(window).on("beforeunload",that.preventPrematureLeaving))}break;case"speech":gspeech+="  "+evt.capturedspeech,theconfig.controls.transcript.val(gspeech),theconfig.controls.answer.val(gspeech);break;case"awaitingprocessing":if("posted"!=theconfig.uploadstate){theconfig.controls.mediaurl.val(evt.mediaurl),theconfig.controls.answer.val(evt.mediaurl);var cpquestionUploaded=new CustomEvent("cpquestionUploaded",{details:evt});document.dispatchEvent(cpquestionUploaded),1==theconfig.safesave&&(theconfig.controls.nextpagebtn.removeAttr("disabled","disabled"),$(window).off("beforeunload",that.preventPrematureLeaving))}theconfig.uploadstate="posted";break;case"error":alert("PROBLEM: "+evt.message)}}))},preventPrematureLeaving:function(e){return log.debug("preventPrematureLeaving has been called"),e.preventDefault(),e.returnValue="Your recording has not been uploaded. Cancel to stay on this page."},register_events:function(config){},logDetails:function(details,answerstatus,theevent){if(details.length>0){var detailsobj={recevents:[]},json_string=details.val();if(null!==json_string&&""!==json_string)try{detailsobj=JSON.parse(json_string)}catch(error){log.debug("not valid details string")}var logdata={};switch(logdata.type=theevent.type,logdata.time=(new Date).toLocaleString("en-us"),theevent.type){case"recording":logdata.action=theevent.action;break;case"awaitingprocessing":logdata.targetfile=theevent.mediaurl;break;case"error":logdata.code=theevent.code,logdata.message=theevent.message;break;case"filesubmitted":logdata.finalfile=theevent.mediaurl;break;case"uploadcommenced":logdata.srcfile=theevent.sourcefilename,logdata.mimetype=theevent.sourcemimetype}detailsobj.recevents.push(logdata),details.val(JSON.stringify(detailsobj)),logdata.insession=!0,logdata[logdata.type]=!0,templates.render("qtype_cloudpoodll/answerstatus",logdata).then((function(html,js){answerstatus.html(html)}))}}}}));

//# sourceMappingURL=cloudpoodllhelper.min.js.map